<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8" />
    <title>Navratri Photo Frame</title>
    <style>
      * {
        box-sizing: border-box;
      }
      
      #root, .app-container {
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }
      
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background-color: #ffffff;
        background-repeat: repeat; /* repeat in both directions */
        background-size: auto; /* use original image size */
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      /* Style the Fuji Film images container */
      .fuji-images-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0px;
        margin: 20px auto;
        animation: zoom-in-reveal 3s ease-out;
      }

      /* Style individual Fuji Film images */
      .fuji-images-container img {
        width: 30%; /* 30% of the container width */
        height: auto; /* Maintains aspect ratio */
        object-fit: contain; /* Ensures the image fits properly */
      }

      @keyframes zoom-in-reveal {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(0.8);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes zoom-in-reveal-center {
        0% {
          transform: translate(-50%, -50%) scale(0.3);
          opacity: 0;
        }
        50% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0.8;
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
      }

      h2::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }

      h2 span {
        display: block;
        position: relative;
        z-index: 1;
        text-align: center;
        margin: 0 auto;
      }

      /* Guidelines styling */
      .guidelines-container {
        text-align: center;
        width: 100%;
        max-width: 100%;
        margin: 20px 0;
        padding: 30px 20px;
        background-color: #ff32b4;
        border-radius: 15px;
        position: relative;
        box-sizing: border-box;
      }
      
      @media (max-width: 1080px) {
        .guidelines-container {
          width: 100vw;
          max-width: 100vw;
          margin: 20px 0;
          padding: 20px 10px;
        }
      }
      
      /* iPhone specific guidelines optimizations */
      @media (max-width: 480px) {
        .guidelines-container {
          width: 100vw;
          max-width: 100vw;
          margin: 10px 0;
          padding: 15px 5px;
        }
      }

      .guidelines-title {
        font-family: "Trois Mille 19 Bold";
        font-weight: bold;
        font-size: 28px;
        margin: 0 0 20px 0;
        color: #ffffff;
        position: relative;
        z-index: 2;
        opacity: 0;
        transition: transform 0.1s ease-out;
        text-decoration: underline;
        text-decoration-color: #ffff00;
        text-decoration-thickness: 0px;
        text-underline-offset: 5px;
        animation: underlineReveal 0.8s ease-out 1.5s forwards;
      }
      
      @keyframes underlineReveal {
        0% {
          text-decoration-thickness: 0px;
        }
        100% {
          text-decoration-thickness: 5px;
        }
      }

      @keyframes character-reveal {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        10% {
          opacity: 1;
          transform: scale(1.2);
        }
        20% {
          transform: scale(1);
        }
        30% {
          transform: scale(1.1);
        }
        40% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        60% {
          transform: scale(1);
        }
        70% {
          transform: scale(1.1);
        }
        80% {
          transform: scale(1);
        }
        90% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes zoom-final {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1.1);
        }
      }

      .guidelines-subheading {
        font-family: "Trois Mille 19 Medium", Arial, sans-serif;
        font-weight: bold;
        font-size: 22px;
        margin: 40px auto 10px auto;
        color: #ffffff;
        text-align: left;
        display: block;
        position: relative;
        z-index: 2;
        width: 100%;
        max-width: 1080px;
        list-style: none;
        padding-left: 0;
      }
      
      @media (max-width: 1080px) {
        .guidelines-subheading {
          max-width: 100vw;
          padding-left: 20px;
          padding-right: 20px;
        }
      }
      
      @media (max-height: 1350px) {
        .guidelines-subheading {
          max-width: calc(100vh * 4 / 5);
          padding-left: 20px;
          padding-right: 20px;
        }
      }

      .guidelines-subheading::before {
        content: "";
        display: inline-block;
        width: 76px;
        height: 16px;
        background: linear-gradient(
          to right,
          #ffd700 0%,
          #ffd700 16px,
          transparent 16px,
          transparent 100%
        );
        margin-right: 15px;
        vertical-align: left;
        border-radius: 2px;
        padding-left: 20px;
      }

      .guidelines-list {
        font-family: "Trois Mille 19 Regular";
        font-weight: normal;
        font-size: 18px;
        color: #ffffff;
        line-height: 1.4;
        text-align: left;
        max-width: 1080px;
        width: 100%;
        list-style: none;
        position: relative;
        z-index: 2;
        margin: 0 auto;
        padding: 0;
      }
      
      @media (max-width: 1080px) {
        .guidelines-list {
          max-width: 100vw;
          padding-left: 20px;
          padding-right: 20px;
        }
      }
      
      @media (max-height: 1350px) {
        .guidelines-list {
          max-width: calc(100vh * 4 / 5);
          padding-left: 20px;
          padding-right: 20px;
        }
      }

      .step-container {
        border: none;
        border-radius: 0;
        margin: 0 auto;
        background-color: transparent;
        position: relative;
        width: 100%;
        text-align: center;
        opacity: 0;
        transform: scale(0.5);
        animation: zoomReveal 0.8s ease-out forwards;
      }
      
      #step1-container {
        animation-delay: 0.5s;
      }
      
      #step2-container {
        animation-delay: 1.0s;
      }
      
      #step3-container {
        animation-delay: 1.5s;
      }
      
      @keyframes zoomReveal {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .camera-wrapper {
        position: relative;
        width: 100%;
        max-width: 1080px;
        margin: 20px auto;
        z-index: 1;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation: frameZoomReveal 1s ease-out 0.5s forwards;
      }
      
      @keyframes frameZoomReveal {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      .camera-container {
        position: relative;
        display: inline-block;
        width: min(100vw, 400px);
        height: calc(min(100vw, 400px) * 5 / 4);
        aspect-ratio: 4 / 5;
        border: none;
        border-radius: 0;
        overflow: hidden;
        max-width: 100vw;
        max-height: calc(100vh - 200px);
      }
      
      /* iPhone specific optimizations */
      @media (max-width: 480px) {
        .camera-container {
          width: min(100vw, 350px);
          height: calc(min(100vw, 350px) * 5 / 4);
          max-width: 100vw;
          max-height: calc(100vh - 150px);
        }
      }
      
      @media (min-width: 1080px) {
        .camera-container {
          width: 1080px;
          height: 1350px;
        }
      }
      /* Buttons container - responsive with frame size */
      .action-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px auto;
        width: 100vw;
        max-width: 100vw;
      }
      
      /* iPhone specific button optimizations */
      @media (max-width: 480px) {
        .action-buttons {
          width: 100vw;
          max-width: 100vw;
          margin: 10px auto;
          gap: 15px;
        }
      }
      
      @media (min-width: 1080px) {
        .action-buttons {
          width: 1080px;
        }
      }
      

      /* Button row for horizontal layout */
      .button-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        width: 100%;
        max-width: 100%;
      }

      video {
        position: absolute;
        top: 25%;
        left: 25%;
        width: 50%;
        height: 50%;
        object-fit: cover;
        z-index: 0;
        border-radius: 0;
      }

      /* Flip video horizontally for front camera (mirror effect) */
      video.front-camera {
        transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
        -moz-transform: scaleX(-1);
        -ms-transform: scaleX(-1);
      }

      /* Flip captured photo horizontally for front camera (mirror effect) */
      #capturedPhoto.front-camera {
        transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
        -moz-transform: scaleX(-1);
        -ms-transform: scaleX(-1);
      }

      /* Overlay frame */
      #frame {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        object-fit: contain;
        z-index: 2;
        border-radius: 0;
      }

      #canvas {
        display: none;
      }

      /* Captured photo overlay inside camera frame */
      #capturedPhoto {
        position: absolute;
        top: 25%;
        left: 25%;
        width: 50%;
        height: 50%;
        object-fit: cover; /* Fill the transparent area */
        display: none;
        z-index: 1; /* above video but below frame */
        border-radius: 0; /* match camera container border radius */
        pointer-events: none; /* prevent any interaction */
        transform: none; /* ensure no transforms */
        transition: none; /* no animations */
        animation: none; /* no animations */
      }

      button {
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: 5px solid #006eff; /* Azure border */
        background-color: #ffffff; /* white fill */
        color: #006eff; /* Azure text */
        font-family: "Trois Mille 19 Regular";
      }

      /* Flip camera button overlay */
      #flipBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 10%;
        background: rgba(0, 0, 0, 0.7);
        background-size: contain;
        background-position: center;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        z-index: 3;
        padding: 5px;
      }

      /* Make SVG paths white */
      #flipBtn svg path {
        fill: #ffffff;
      }

      /* Increase SVG size */
      #flipBtn svg {
        width: 30px;
        height: 30px;
      }
      /* Common button styles */
      .btn {
        display: inline-block;
        width: 180px; /* increased by 50% from 120px */
        height: 60px; /* increased by 50% from 40px */
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        cursor: pointer;
        border: none;
        text-decoration: none;
        flex-shrink: 0; /* prevent buttons from shrinking */
      }

      /* Capture button background */
      .capture-btn {
        background-image: url("{{ url_for('static', filename='Capture.png') }}");
        transition: none;
        animation: none;
      }

      /* Re-capture button background */
      .recapture-btn {
        background-image: url("{{ url_for('static', filename='Re-capture.png') }}");
        transition: none;
        animation: none;
      }

      /* Download button background */
      .download-btn {
        background-image: url("{{ url_for('static', filename='Download.png') }}");
        transition: none;
        animation: none;
      }
    </style>
  </head>
  <body>
    <div class="fuji-images-container">
      <img
        src="{{ url_for('static', filename='Fuji_Film_1.png') }}"
        alt="image"
      />
      <img
        src="{{ url_for('static', filename='Fuji_Film_2.png') }}"
        alt="image"
      />
      <img
        src="{{ url_for('static', filename='Fuji_Film_3.png') }}"
        alt="image"
      />
    </div> 
    <!-- Camera + Buttons Wrapper -->
    <div class="camera-wrapper">
      <!-- Camera + Frame Overlay -->
      <div class="camera-container">
        <video id="camera" autoplay playsinline></video>
        <button id="flipBtn" aria-label="Flip camera" title="Flip camera">
          <svg
            id="Layer_1"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            viewBox="0 0 40 50"
          >
            <!-- Generator: Adobe Illustrator 29.8.1, SVG Export Plug-In . SVG Version: 2.1.1 Build 2)  -->
            <defs>
              <style>
                .st0 {
                  fill-rule: evenodd;
                }
              </style>
            </defs>
            <path
              class="st0"
              d="M5,17.07c0-1.93,0-2.9.46-3.63.15-.24.33-.45.54-.64.65-.58,1.6-.74,3.51-1.05l4.49-.75.19-.5c.56-1.5.84-2.25,1.4-2.74.18-.16.38-.3.6-.41.66-.35,1.46-.35,3.06-.35h1.52c1.6,0,2.41,0,3.06.35.21.11.42.25.6.41.55.49.84,1.24,1.4,2.74l.19.5,4.49.75c1.91.32,2.86.48,3.51,1.05.21.19.39.4.54.64.46.73.46,1.7.46,3.63v9.53c0,2.25,0,3.37-.57,4.16-.19.25-.41.48-.66.66-.79.57-1.91.57-4.16.57H10.4c-2.25,0-3.37,0-4.16-.57-.25-.19-.48-.41-.66-.66-.57-.79-.57-1.91-.57-4.16v-9.53ZM20,29c1.44,0,2.8-.38,3.97-1.05l-.99-1.74c-.88.5-1.89.79-2.98.79-2.97,0-5.44-2.16-5.92-5h2.48l-3.03-5.25c-.19-.33-.67-.33-.87,0l-3.03,5.25h2.43c.49,3.95,3.86,7,7.94,7ZM20,13c4.08,0,7.45,3.05,7.94,7h2.43l-3.03,5.25c-.19.33-.67.33-.87,0l-3.03-5.25h2.48c-.48-2.84-2.94-5-5.92-5-1.08,0-2.1.29-2.98.79l-.99-1.74c1.17-.67,2.53-1.05,3.97-1.05Z"
            />
            <path
              d="M7.5,9.3c0-.75,0-1.12.19-1.39.06-.08.14-.16.22-.22.26-.19.64-.19,1.39-.19h.9c.75,0,1.12,0,1.39.19.08.06.16.14.22.22.19.26.19.64.19,1.39v.1l-4.5.75v-.85Z"
            />
          </svg>
        </button>
        <img
          id="frame"
          src="{{ url_for('static', filename='navratri_frame.png') }}"
        />
        <!-- Captured photo overlay -->
        <img id="capturedPhoto" style="display: none" />
      </div>
    </div>
    
    <!-- Action Buttons: placed below the camera wrapper -->
    <div class="action-buttons">
      <div class="button-row">
        <a
          id="capture"
          class="btn capture-btn"
          style="display: inline-block"
        ></a>
        <a
          id="downloadBtn"
          class="btn download-btn"
          style="display: none"
          download="navratri_click.png"
        ></a>
      </div>
    </div>
    <br />

    <!-- Guidelines Section Below Camera -->
    <div class="guidelines-container">
      <h1 class="guidelines-title" id="guidelines-title">Guidelines</h1>
      <br />
      <div class="step-container" id="step1-container">
        <h2 class="guidelines-subheading" id="step1-title"><a>Step 1</a><h2>
        <ul class="guidelines-list">
          <li id="step1-text">
            Pose in the SkyBlue Poloroid Frame and Download your best capture
          </li>
        </ul>
      </div>
      <br />
      <div class="step-container" id="step2-container">
        <h2 class="guidelines-subheading" id="step2-title"><a>Step 2</a><h2>
        <ul class="guidelines-list">
          <li id="step2-text">
            Post on instagram with tag #SkyBlueFestiveClicks and tag your city
            (for example #Ahmedabad, #Vadodara, etc.)
          </li>
        </ul>
      </div>
      <br />
      <div class="step-container" id="step3-container">
        <h2 class="guidelines-subheading" id="step3-title"><a>Step 3</a><h2>
        <ul class="guidelines-list">
          <li id="step3-text">Gather Likes , Comments and Reshares before 5 October'2025</li>
        </ul>
      </div>
    </div>

    <!-- Hidden Canvas -->
    <canvas id="canvas"></canvas>

    <script>
      const video = document.getElementById("camera");
      const canvas = document.getElementById("canvas");
      const capturedPhoto = document.getElementById("capturedPhoto");
      const button = document.getElementById("capture");
      const frame = document.getElementById("frame");
      const downloadBtn = document.getElementById("downloadBtn");
      const flipBtn = document.getElementById("flipBtn");
      const container = document.querySelector(".camera-container");

      let currentFacingMode = "environment"; // or "user"
      let currentStream = null;

      async function startCamera() {
        try {
          // Stop any existing stream before starting a new one
          if (currentStream) {
            currentStream.getTracks().forEach((t) => t.stop());
            currentStream = null;
          }

          const constraints = { video: { facingMode: currentFacingMode } };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          currentStream = stream;
          video.srcObject = stream;

          // Set initial front-camera class for mirror effect
          if (currentFacingMode === "user") {
            video.classList.add("front-camera");
            console.log("Front camera: mirror effect applied");
          } else {
            video.classList.remove("front-camera");
            console.log("Back camera: mirror effect removed");
          }
        } catch (err) {
          console.error("Camera error:", err);
          alert("Camera not accessible: " + err.message + "\n\nPlease ensure:\n1. You're using HTTPS\n2. Camera permissions are granted\n3. Your device has a camera");
        }
      }

      // Initialize camera on load
      startCamera();

      // Character reveal animation function
      function animateText(elementId, delay = 0) {
        return new Promise((resolve) => {
          setTimeout(() => {
            const element = document.getElementById(elementId);
            if (!element) {
              resolve();
              return;
            }

            const text = element.textContent;
            element.textContent = "";
            element.style.opacity = "1";

            let i = 0;
            const interval = setInterval(() => {
              if (i < text.length) {
                element.textContent += text[i];
                element.style.transform = "scale(1.1)";
                setTimeout(() => {
                  element.style.transform = "scale(1)";
                }, 80);
                i++;
              } else {
                clearInterval(interval);
                // Final zoom effect for titles
                if (
                  elementId.includes("title") ||
                  elementId === "guidelines-title"
                ) {
                  setTimeout(() => {
                    element.style.animation = "zoom-final 0.5s ease-out";
                  }, 300);
                }
                resolve();
              }
            }, 150);
          }, delay);
        });
      }

      // Animate only the guidelines title
      function animateGuidelinesTitle() {
        animateText("guidelines-title", 1000);
      }

      // Start title animation when page loads
      animateGuidelinesTitle();

      // Ensure container uses the frame's true aspect ratio for portrait layout
      frame.onload = () => {
        if (frame.naturalWidth && frame.naturalHeight) {
          container.style.aspectRatio = `${frame.naturalWidth} / ${frame.naturalHeight}`;
        }
      };

      // Flip camera handler
      flipBtn.onclick = async () => {
        console.log("Flip button clicked, switching from", currentFacingMode);
        currentFacingMode =
          currentFacingMode === "environment" ? "user" : "environment";
        console.log("Switching to", currentFacingMode);
        await startCamera();

        // Add/remove front-camera class for mirror effect
        if (currentFacingMode === "user") {
          video.classList.add("front-camera");
          // Also update captured photo if it's displayed
          if (capturedPhoto.style.display === "block") {
            capturedPhoto.classList.add("front-camera");
          }
          console.log("Switched to front camera: mirror effect applied");
        } else {
          video.classList.remove("front-camera");
          // Also update captured photo if it's displayed
          if (capturedPhoto.style.display === "block") {
            capturedPhoto.classList.remove("front-camera");
          }
          console.log("Switched to back camera: mirror effect removed");
        }
      };

      // Re-capture function
      function recapturePhoto() {
        // Hide captured photo and show video again
        capturedPhoto.style.display = "none";
        capturedPhoto.classList.remove("front-camera"); // Reset transform
        video.style.display = "block";

        // Show flip camera button again by restoring z-index
        flipBtn.style.zIndex = "2";

        // Hide download button
        downloadBtn.style.display = "none";

        // Reset capture button to original function
        button.onclick = capturePhoto;
      }

      // Capture logic (exports portrait with center-cropped video)
      function capturePhoto() {
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          alert("Video not ready yet, try again.");
          return;
        }

        // Target size exactly matches the visible capture area (canvas) ratio
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        const targetWidth = Math.round(rect.width * dpr);
        const targetHeight = Math.round(rect.height * dpr);
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext("2d");

        // Center-crop the video to cover the portrait canvas
        const srcW = video.videoWidth;
        const srcH = video.videoHeight;
        const targetAspect = targetWidth / targetHeight;
        const srcAspect = srcW / srcH;

        let sx = 0;
        let sy = 0;
        let sWidth = srcW;
        let sHeight = srcH;

        if (srcAspect > targetAspect) {
          // Source is wider than target -> crop width
          sWidth = Math.round(srcH * targetAspect);
          sx = Math.round((srcW - sWidth) / 2);
        } else if (srcAspect < targetAspect) {
          // Source is taller than target -> crop height
          sHeight = Math.round(srcW / targetAspect);
          sy = Math.round((srcH - sHeight) / 2);
        }

        ctx.drawImage(
          video,
          sx,
          sy,
          sWidth,
          sHeight,
          0,
          0,
          targetWidth,
          targetHeight
        );

        // Draw overlay frame to exact canvas size
        ctx.drawImage(frame, 0, 0, targetWidth, targetHeight);

        // Create image data
        const dataURL = canvas.toDataURL("image/png");

        // Show captured photo inside the camera frame with exact same positioning as video
        capturedPhoto.src = dataURL;
        capturedPhoto.style.display = "block";

        // Apply the same transform as video if it's front camera
        if (currentFacingMode === "user") {
          capturedPhoto.classList.add("front-camera");
        } else {
          capturedPhoto.classList.remove("front-camera");
        }

        console.log("Captured photo displayed, video hidden");

        // Hide video and show captured photo
        video.style.display = "none";

        // Hide flip camera button behind captured photo by reducing z-index
        flipBtn.style.zIndex = "0";

        // Enable download button
        downloadBtn.href = dataURL;
        downloadBtn.style.display = "inline-block";

        // Change capture button to re-capture
        button.className = "btn recapture-btn";
        button.onclick = recapturePhoto;

        // Send to Flask backend
        fetch("/save_photo", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "image=" + encodeURIComponent(dataURL),
        })
          .then((res) => res.text())
          .then((msg) => console.log("Server:", msg))
          .catch((err) => console.error("Upload failed:", err));
      }

      // Set initial button onclick
      button.onclick = capturePhoto;
    </script>
  </body>
</html>
